<!--
  - Copyright 2020 LABOR.digital
  -
  - Licensed under the Apache License, Version 2.0 (the "License");
  - you may not use this file except in compliance with the License.
  - You may obtain a copy of the License at
  -
  -     http://www.apache.org/licenses/LICENSE-2.0
  -
  - Unless required by applicable law or agreed to in writing, software
  - distributed under the License is distributed on an "AS IS" BASIS,
  - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  - See the License for the specific language governing permissions and
  - limitations under the License.
  -
  - Last modified: 2020.06.26 at 11:40
  -->

<template>
    <dl class="accordion" :key="groupId">
        <div v-for="(item, index) in preparedItems" :id="groupId + '-' + index"
             class="accordion__container"
             :class="classes">
            <dt @click="onClickToggle(index)" class="accordion__label"
                :class="{'accordion__label--active': openInternal[index]}"
                ref="titles">

                <!-- @slot Used to add additional elements before the label -->
                <slot name="beforeLabel"/>

                <!-- @slot Default label slot for your elements. As default the label from the given items will be used -->
                <slot name="label" :label="item.label">{{ item.label }}</slot>

                <!-- @slot Used to add additional elements after the label -->
                <slot name="afterLabel"/>
            </dt>

            <transition
                name="accordion"
                @enter="startTransition"
                @after-enter="endTransition"
                @before-leave="startTransition"
                @after-leave="endTransition">
                <dd v-show="openInternal[index]"
                    class="accordion__item"
                    :class="{'accordion__item--active': openInternal[index]}"
                    ref="contents">

                    <!-- @slot Used to add additional elements before the content -->
                    <slot name="beforeContent"/>

                    <!-- @slot Default item slot for your elements -->
                    <slot :name="item.label"></slot>

                    <!-- @slot Used to add additional elements after the content -->
                    <slot name="afterContent"/>
                </dd>
            </transition>
        </div>
    </dl>
</template>

<script lang="ts">
import {forEach} from "@labor-digital/helferlein/lib/Lists/forEach";
import {isArray} from "@labor-digital/helferlein/lib/Types/isArray";

export default {
    name: "BaseAccordion",
    props: {

        /**
         * The list of items that should be used. The items are also the name
         * for the looped slots in which you can put your content in.
         */
        items: {
            type: Array,
            required: true
        },

        /**
         * Set this to true if you want to open multiple accordions
         * at once without closing the other ones.
         */
        openMultiple: {
            type: Boolean,
            default: false
        },

        /**
         * If "items" contains an array of objects, this prop is used to select the object's property
         * which should be used as a label.
         */
        itemLabel: String,

        /**
         * Add custom classes if necessary to the accordion container.
         */
        classes: String,


        /**
         * If index of the element given it opens the accordion. Use open.sync to get the value back if needed.
         * The component will listen to changes of the prop. If openMultiple is true you can give an array of indexes to open multiple
         */
        open: [Number, Array]
    },
    computed: {
        preparedItems() {
            const items = [];
            forEach(this.items, (item, index) => {
                items[index] = {
                    id: index,
                    label: item.label ?? item[this.itemLabel] ?? item
                };
            });
            return items;
        }
    },
    data() {
        return {
            groupId: null,
            openInternal: []
        };
    },
    methods: {
        onClickToggle(i) {
            if (this.openMultiple) {
                this.$set(this.openInternal, i, !this.openInternal[i]);
            } else {
                forEach(this.openInternal, (item, index) => {
                    if (index === i) {
                        this.$set(this.openInternal, index, !this.openInternal[i]);
                    } else {
                        this.$set(this.openInternal, index, false);
                    }
                });
            }

            /**
             * Emits an event with "open" and the index of the accordion
             */
            this.$emit("open", this.openInternal);
            this.$emit("update:open", this.openInternal);
        },
        startTransition(el) {
            el.style.height = el.scrollHeight + "px";
        },
        endTransition(el) {
            el.style.height = "";
        },
        onChangeOpen() {
            if (isArray(this.open) && !this.openMultiple) return;
            forEach(this.items, (item, index) => {
                this.openInternal[index] = isArray(this.open) ? this.open.includes(index) : this.open === index;
            });
        }
    },
    mounted() {
        this.groupId = "ba-" + this._uid;

        this.onChangeOpen();
    },
    watch: {
        open() {
            this.onChangeOpen();
        }
    }
};
</script>

<style scoped lang="sass" src="./BaseAccordion.sass"></style>

